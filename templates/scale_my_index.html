{% extends "base.html" %}

{% block title %}担当文献一覧（尺度）{% endblock %}

{% block content %}

<div class="d-flex justify-content-between align-items-end mb-3">
  <div>
    <h3 class="mb-1">
      <i class="bi bi-list-check me-2"></i>担当文献一覧（尺度）
    </h3>
    <p class="text-muted mb-0">
      ユーザー: <strong>{{ view_user.username }}</strong> 
      <span class="badge bg-light text-dark border ms-2">Group {{ view_user.group_no }}</span>
    </p>
  </div>
  
  <div class="text-end">
    <span class="badge bg-success fs-6">
      進捗: {{ progress_done }} / {{ progress_total }} ({{ progress_pct }}%)
    </span>
  </div>
</div>

<div class="card shadow-sm">
  <div class="card-body p-0">
    <div class="table-responsive">
      {% if rows and rows|length > 0 %}
        <table class="table table-hover table-striped mb-0 align-middle">
          <thead class="table-light">
            <tr>
              <th class="ps-3" style="width: 60px;">#</th>
              <th style="width: 100px;">PMID</th>
              <th>タイトル</th>
              <th style="width: 100px;">ステータス</th>
              <th style="width: 80px;">判定</th>
              <th style="width: 120px;"></th>
            </tr>
          </thead>
          <tbody>
            {% for article, decision in rows %}
              <tr>
                <td class="ps-3 text-muted">{{ loop.index }}</td>
                <td>
                  <a href="https://pubmed.ncbi.nlm.nih.gov/{{ article.pmid }}/" target="_blank" class="text-decoration-none text-secondary">
                    {{ article.pmid }} <i class="bi bi-box-arrow-up-right small"></i>
                  </a>
                </td>
                <td>
                  <div class="fw-bold text-dark" style="font-size: 0.95rem;">
                    {{ article.title_ja or article.title_en }}
                  </div>
                  {% if article.title_ja and article.title_en %}
                    <div class="text-muted small text-truncate" style="max-width: 500px;">{{ article.title_en }}</div>
                  {% endif %}
                </td>

                <td>
                  {% if decision and (decision.rating is not none) %}
                    <span class="badge bg-success-subtle text-success border border-success-subtle">評価済み</span>
                  {% else %}
                    <span class="badge bg-secondary-subtle text-secondary border border-secondary-subtle">未評価</span>
                  {% endif %}
                </td>

                <td class="fw-bold text-center">
                  {% if decision and (decision.rating is not none) %}
                    {{ decision.rating }}
                  {% else %}
                    -
                  {% endif %}
                </td>

                <td class="text-end pe-3">
                  {# group_no を付与してリンク #}
                  <a class="btn btn-sm btn-outline-success"
                     href="/scale_screen?article_index={{ loop.index }}&group_no={{ view_user.group_no }}">
                    <i class="bi bi-arrow-right-circle me-1"></i>確認
                  </a>
                </td>
              </tr>
            {% endfor %}
          </tbody>
        </table>
      {% else %}
        <div class="p-5 text-center text-muted">
          <i class="bi bi-inbox fs-1 d-block mb-3"></i>
          該当する文献はありません。
        </div>
      {% endif %}
    </div>
  </div>
</div>
{% endblock %}
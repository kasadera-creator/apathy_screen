{% extends "base.html" %}

{% block title %}二次レビュー - {{ pmid }}{% endblock %}

{% block content %}
<div class="container-xl">
  <div class="mb-2">
    <h3 class="mb-1">{{ SECONDARY_GROUP_LABELS[group] if group in SECONDARY_GROUP_LABELS else group }} 担当グループの二次スクリーニング</h3>
    <div class="d-flex justify-content-between align-items-center">
      <div>
        <div class="mb-0">進捗: {{ progress_done }}/{{ progress_total }}</div>
        {% if current_index %}
          <div class="text-muted small">（文献番号: {{ current_index }} / {{ progress_total }}）</div>
        {% endif %}
      </div>
      <div class="text-end small">
        <a class="text-decoration-none text-secondary" href="/secondary/{{ group }}/next">次へ（未評価へ） →</a>
      </div>
    </div>
  </div>
  <div class="review-layout">
    <div class="review-left">
    <div class="card mb-3 shadow-sm">
      <div class="card-body">
        <div class="d-flex justify-content-between align-items-start flex-wrap">
          <div>
            <div class="mb-2">
              <span class="badge bg-secondary me-2">PMID</span>
              {% if pmid %}
                <a href="https://pubmed.ncbi.nlm.nih.gov/{{ pmid }}/" target="_blank" rel="noopener">{{ pmid }}</a>
              {% else %}
                —
              {% endif %}
            </div>
            {% if article and article.doi %}
            <div class="mb-2">
              <span class="badge bg-info text-dark me-2">DOI</span>
              <a href="https://doi.org/{{ article.doi }}" target="_blank" rel="noopener">{{ article.doi }}</a>
            </div>
            {% endif %}
          </div>
        </div>
        <hr class="my-2">
        <h5 class="card-title mb-1">Title</h5>
        <h6 class="mb-2">{{ article.title_en if article else "(no title)" }}</h6>
        <p class="text-muted small mb-0">{{ article.title_ja or "(日本語タイトルはありません)" }}</p>
      </div>
    </div>

    <div class="card mb-3 shadow-sm">
      <div class="card-body">
        <h5 class="card-title">Abstract</h5>
        <p class="mb-0" style="white-space:pre-wrap;">{{ article.abstract_en if article else "" }}</p>
      </div>
    </div>

    <div class="card mb-3 shadow-sm">
      <div class="card-body">
        <h5 class="card-title">要旨（DeepL翻訳）</h5>
        {% if article %}
          <p class="mb-0" style="white-space:pre-wrap;">{{ article.abstract_ja or "" }}</p>
        {% else %}
          <div class="alert alert-info mb-0">一次DBに該当レコードがありません（後でimport予定）。以下は二次DBの情報で代替表示しています。</div>
          {% if secondary %}
            <p class="mt-2 mb-1"><strong>PMID:</strong> {{ secondary.pmid }}</p>
            <p class="mb-0"><strong>フラグ:</strong>
              {% if secondary.is_physical %} 身体的要因 {% endif %}
              {% if secondary.is_brain %} 脳神経疾患 {% endif %}
              {% if secondary.is_psycho %} 精神・心理・環境要因 {% endif %}
              {% if secondary.is_drug %} 薬剤性 {% endif %}
            </p>
          {% endif %}
        {% endif %}
      </div>
    </div>

    <hr>

    {% set _pmid = pmid if (pmid is defined and pmid) else (
        (article.pmid if (article is defined and article and article.pmid) else (
            (secondary.pmid if (secondary is defined and secondary and secondary.pmid) else (
                (item.pmid if (item is defined and item and item.pmid) else (
                    (sec.pmid if (sec is defined and sec and sec.pmid) else (
                        (cand.pmid if (cand is defined and cand and cand.pmid) else (
                            (rec.pmid if (rec is defined and rec and rec.pmid) else None)
                        ))
                    ))
                ))
            ))
        ))
    ) %}

    <div class="card mb-3 shadow-sm">
      <div class="card-body p-0">
        <div class="pdf-panel">
          <div class="pdf-panel__toolbar">
            {% if pdf_url %}
              <a class="btn btn-sm btn-outline-primary" href="{{ pdf_url }}" target="_blank" rel="noopener">PDFを別タブで開く</a>
            {% else %}
              <button class="btn btn-sm btn-outline-secondary" disabled>PDFを別タブで開く</button>
            {% endif %}
          </div>
          {% if pdf_url %}
            <iframe class="pdf-panel__iframe" src="{{ pdf_url }}" title="PDF {{ _pmid }}" loading="lazy"></iframe>
          {% else %}
            <div class="alert alert-warning m-2">
              PDFが利用できません。
            </div>
          {% endif %}
        </div>
      </div>
    </div>
    </div>

    <div class="review-right">
    <div class="card mb-3 shadow-sm">
      <div class="card-header bg-light py-2">
        <h5 class="card-title fw-bold mb-0 text-dark"><i class="bi bi-robot me-2"></i>Gemini 2.5 本文要約</h5>
      </div>
      <div class="card-body">
        <details class="gemini-box" {% if auto and auto.needs_review %}open{% endif %}>
          <summary>内容を表示 / 非表示{% if auto and auto.auto_confidence %}（信頼度: {{ auto.auto_confidence }}）{% endif %}</summary>
          <div class="mt-2">
            {% if auto %}
              <p><strong>対象疾患・病態:</strong> {{ auto.auto_target_condition }}</p>
              <p><strong>意欲低下を示す用語:</strong> {{ auto.auto_apathy_terms }}</p>
              <p><strong>母集団・N:</strong> {{ auto.auto_population_N }}</p>
              <p><strong>頻度（有症率）:</strong> {{ auto.auto_prevalence }}</p>
              <p><strong>介入:</strong> {{ auto.auto_intervention }}</p>
            {% else %}
              {% if auto_error %}
                <div class="alert alert-danger mb-0">{{ auto_error }}</div>
              {% else %}
                <div class="alert alert-secondary mb-0">自動抽出は処理中／未反映です（後から反映されます）</div>
              {% endif %}
            {% endif %}
          </div>
        </details>
      </div>
    </div>

    <div class="card mb-3 shadow-sm">
      <div class="card-header bg-light py-2">
        <h5 class="card-title fw-bold mb-0 text-dark"><i class="bi bi-pencil-square me-2"></i>レビュー (あなた)
          {% if review.completed_at %}
          <span class="badge bg-info ms-2">完了済み</span>
          {% endif %}
        </h5>
      </div>
      <div class="card-body">
        {% if review.completed_at %}
        <div class="alert alert-info mb-3">
          <strong>ℹ️ 完了済みレビュー：</strong> このレビューは {{ review.completed_at }} に完了されています。
          修正内容を保存する場合は「保存」ボタンで再保存してください。
        </div>
        {% endif %}
      <form method="post" action="/secondary/{{ group }}/{{ pmid }}/save">
        {% set _initial_decision = (review.decision if review.decision in ['include','exclude'] else '') %}
        <div class="mb-3">
          <label class="form-label">判定</label>
          <p class="small text-muted mb-2">アパシー・意欲低下をきたす病態・状態を調査するために、担当領域としてシステマティックレビューに含める価値があるか</p>
          <input type="hidden" name="decision" id="decision_input" value="{{ _initial_decision }}">
          <div class="d-flex gap-2 mb-2" role="group" aria-label="判定ボタン">
            <button type="button" class="{% if _initial_decision=='include' %}btn btn-lg btn-success{% else %}btn btn-lg btn-outline-success{% endif %} decision-btn flex-fill {% if _initial_decision=='include' %}selected{% endif %}" data-value="include">採用</button>
            <button type="button" class="{% if _initial_decision=='exclude' %}btn btn-lg btn-danger{% else %}btn btn-lg btn-outline-danger{% endif %} decision-btn flex-fill {% if _initial_decision=='exclude' %}selected{% endif %}" data-value="exclude">除外</button>
          </div>
        </div>

        <div class="mb-2">
          <label class="form-label">意欲低下を示す用語（apathy/avolition 等）</label>
          <textarea class="form-control review-textarea" name="final_apathy_terms" rows="3">{{ review.final_apathy_terms or (auto.auto_apathy_terms if auto else '') }}</textarea>
        </div>

        <div class="mb-2">
          <label class="form-label">対象疾患・病態</label>
          <textarea class="form-control review-textarea" name="final_target_condition" rows="3">{{ review.final_target_condition or (auto.auto_target_condition if auto else '') }}</textarea>
        </div>

        <div class="mb-2">
          <label class="form-label">母集団・N</label>
          <textarea class="form-control review-textarea" name="final_population_n" rows="4">{{ review.final_population_n or (auto.auto_population_N if auto else '') }}</textarea>
        </div>

        <div class="mb-2">
          <label class="form-label">頻度（有症率）</label>
          <textarea class="form-control review-textarea" name="final_prevalence" rows="4">{{ review.final_prevalence or (auto.auto_prevalence if auto else '') }}</textarea>
        </div>

        <div class="mb-2">
          <label class="form-label">介入（治療・リハビリ）</label>
          <textarea class="form-control review-textarea" name="final_intervention" rows="4">{{ review.final_intervention or (auto.auto_intervention if auto else '') }}</textarea>
        </div>

        <div class="d-flex justify-content-between align-items-center pt-3 border-top nav-controls">
          <div class="d-flex gap-2">
            <button class="btn btn-sm btn-outline-secondary" type="submit" name="nav" value="prev" formnovalidate>
              <i class="bi bi-chevron-left"></i> 1つ前に戻る
            </button>

            <div class="d-flex align-items-center gap-2">
              <span class="small text-muted">移動:</span>
              <input type="number" name="jump_index" min="1" max="{{ progress_total }}" class="form-control form-control-sm" style="width:4.5rem;" />
              <button class="btn btn-sm btn-outline-secondary" type="submit" name="nav" value="jump" formnovalidate>Go</button>
            </div>
          </div>

          <div class="d-flex gap-2">
            {% if not review.completed_at %}
            <!-- Mark as Completed button when not yet completed -->
            <button class="btn btn-sm btn-warning px-2" type="submit" name="action" value="complete" formnovalidate>
              <i class="bi bi-check-circle"></i> 完了として保存
            </button>
            {% else %}
            <!-- Already completed indicator -->
            <span class="badge bg-info align-self-center">✓ 完了済み</span>
            {% endif %}
            
            <button class="btn btn-sm btn-primary px-2 fw-bold" type="submit" name="nav" value="next">保存して次へ <i class="bi bi-chevron-right"></i></button>
          </div>
        </div>
      </form>
      </div>
    </div>
  </div>
</div>

<style>
/* ===== two-pane layout (use Bootstrap container-xl for centering) ===== */
.review-layout{
  display: grid;
  grid-template-columns: minmax(0, 1fr) 420px;
  gap: 24px;
  align-items: start;
}

.review-left{
  min-width: 0;
}

.review-right{
  position: sticky;
  top: 88px; /* navbar高さに合わせる */
  align-self: start;
}

/* Mobile */
@media (max-width: 991px){
  .review-layout{
    grid-template-columns: 1fr;
  }
  .review-right{
    position: static;
  }
}

/* PDF panel */
.pdf-panel { border:1px solid #ddd; border-radius:8px; overflow:hidden; background:#fff; }
.pdf-panel__toolbar { display:flex; justify-content:flex-end; padding:8px 10px; border-bottom:1px solid #eee; background:#fafafa; }
.pdf-panel__iframe { width:100%; height:70vh; border:0; }
@media (max-width:767px) { .pdf-panel__iframe { height:60vh; } }

/* Gemini */
details.gemini-box > summary{
  cursor:pointer;
  font-weight:600;
}

/* Review textarea sizing */
.review-textarea {
  min-height: 6em;
  resize: vertical;
  white-space: pre-wrap;
  overflow-wrap: break-word;
}

/* Compact nav control buttons */
.nav-controls .btn-sm {
  padding-top: 0.28rem;
  padding-bottom: 0.28rem;
  font-size: 0.85rem;
}
.nav-controls input.form-control-sm { height: calc(1.5rem + 2px); padding: 0.25rem 0.4rem; font-size:0.85rem; }

/* Decision buttons */
.decision-btn.selected {
  box-shadow: 0 0 0 3px rgba(0,0,0,0.06) inset, 0 6px 18px rgba(0,0,0,0.06);
  transform: translateY(-1px);
}
.decision-btn { font-weight:700; }

</style>

<script>
document.addEventListener('DOMContentLoaded', function(){
  var btns = document.querySelectorAll('.decision-btn');
  var input = document.getElementById('decision_input');
  if(!input) return;
  btns.forEach(function(b){
    b.addEventListener('click', function(){
      var val = this.getAttribute('data-value');
      // reset all to outline and remove selected
      btns.forEach(function(x){
        x.classList.remove('selected');
        if(x.getAttribute('data-value') === 'include'){
          x.classList.remove('btn-success');
          if(!x.classList.contains('btn-outline-success')) x.classList.add('btn-outline-success');
          x.classList.remove('btn-outline-danger');
        } else {
          x.classList.remove('btn-danger');
          if(!x.classList.contains('btn-outline-danger')) x.classList.add('btn-outline-danger');
          x.classList.remove('btn-outline-success');
        }
      });
      // set clicked to filled variant
      if(val === 'include'){
        this.classList.remove('btn-outline-success');
        this.classList.add('btn-success');
      } else {
        this.classList.remove('btn-outline-danger');
        this.classList.add('btn-danger');
      }
      this.classList.add('selected');
      input.value = val;
    });
  });
});
</script>
</style>

{% endblock %}

{% extends "base.html" %}

{% block title %}二次レビュー - {{ pmid }}{% endblock %}

{% block content %}
<div class="review-layout-full">
  <div class="review-layout">
    <div class="review-left">
    <div class="card mb-3 shadow-sm">
      <div class="card-body">
        <div class="d-flex justify-content-between align-items-start flex-wrap">
          <div>
            <div class="mb-2">
              <span class="badge bg-secondary me-2">PMID</span>
              {% if pmid %}
                <a href="https://pubmed.ncbi.nlm.nih.gov/{{ pmid }}/" target="_blank" rel="noopener">{{ pmid }}</a>
              {% else %}
                —
              {% endif %}
            </div>
            {% if article and article.doi %}
            <div class="mb-2">
              <span class="badge bg-info text-dark me-2">DOI</span>
              <a href="https://doi.org/{{ article.doi }}" target="_blank" rel="noopener">{{ article.doi }}</a>
            </div>
            {% endif %}
          </div>
        </div>
      </div>
    </div>

    <div class="card mb-3 shadow-sm">
      <div class="card-body">
        <h5 class="card-title">Title</h5>
        <h6 class="mb-2">{{ article.title_en if article else "(no title)" }}</h6>
        <p class="text-muted small mb-0">{{ article.title_ja or "(日本語タイトルはありません)" }}</p>
      </div>
    </div>

    <div class="card mb-3 shadow-sm">
      <div class="card-body">
        <h5 class="card-title">Abstract</h5>
        <p class="mb-0" style="white-space:pre-wrap;">{{ article.abstract_en if article else "" }}</p>
      </div>
    </div>

    <div class="card mb-3 shadow-sm">
      <div class="card-body">
        <h5 class="card-title">要旨（DeepL翻訳）</h5>
        {% if article %}
          <p class="mb-0" style="white-space:pre-wrap;">{{ article.abstract_ja or "" }}</p>
        {% else %}
          <div class="alert alert-info mb-0">一次DBに該当レコードがありません（後でimport予定）。以下は二次DBの情報で代替表示しています。</div>
          {% if secondary %}
            <p class="mt-2 mb-1"><strong>PMID:</strong> {{ secondary.pmid }}</p>
            <p class="mb-0"><strong>フラグ:</strong>
              {% if secondary.is_physical %} 身体的要因 {% endif %}
              {% if secondary.is_brain %} 脳神経疾患 {% endif %}
              {% if secondary.is_psycho %} 精神・心理・環境要因 {% endif %}
              {% if secondary.is_drug %} 薬剤性 {% endif %}
            </p>
          {% endif %}
        {% endif %}
      </div>
    </div>

    <hr>

    {% set _pmid = pmid if (pmid is defined and pmid) else (
        (article.pmid if (article is defined and article and article.pmid) else (
            (secondary.pmid if (secondary is defined and secondary and secondary.pmid) else (
                (item.pmid if (item is defined and item and item.pmid) else (
                    (sec.pmid if (sec is defined and sec and sec.pmid) else (
                        (cand.pmid if (cand is defined and cand and cand.pmid) else (
                            (rec.pmid if (rec is defined and rec and rec.pmid) else None)
                        ))
                    ))
                ))
            ))
        ))
    ) %}

    <div class="card mb-3 shadow-sm">
      <div class="card-body p-0">
        <div class="pdf-panel">
          <div class="pdf-panel__toolbar">
            {% if _pmid %}
              <a class="btn btn-sm btn-outline-primary" href="/pdf/{{ _pmid }}" target="_blank" rel="noopener">PDFを別タブで開く</a>
            {% else %}
              <button class="btn btn-sm btn-outline-secondary" disabled>PDFを別タブで開く</button>
            {% endif %}
          </div>
          {% if _pmid %}
            <iframe class="pdf-panel__iframe" src="/pdf/{{ _pmid }}" title="PDF {{ _pmid }}" loading="lazy"></iframe>
          {% else %}
            <div class="alert alert-warning m-2">
              PMIDがテンプレに渡っていないためPDFリンクを生成できません。サーバ側で pmid 変数名を確認してください。
            </div>
          {% endif %}
        </div>
      </div>
    </div>
    </div>

    <div class="review-right">
    <div class="card mb-3 shadow-sm">
      <div class="card-header bg-light py-2">
        <h5 class="card-title fw-bold mb-0 text-dark"><i class="bi bi-robot me-2"></i>Gemini 2.5 本文要約</h5>
      </div>
      <div class="card-body">
        <details class="gemini-box" {% if auto and auto.needs_review %}open{% endif %}>
          <summary>内容を表示 / 非表示{% if auto and auto.auto_confidence %}（信頼度: {{ auto.auto_confidence }}）{% endif %}</summary>
          <div class="mt-2">
            {% if auto %}
              <p><strong>対象疾患・病態:</strong> {{ auto.auto_target_condition }}</p>
              <p><strong>意欲低下を示す用語:</strong> {{ auto.auto_apathy_terms }}</p>
              <p><strong>母集団・N:</strong> {{ auto.auto_population_N }}</p>
              <p><strong>頻度（有症率）:</strong> {{ auto.auto_prevalence }}</p>
              <p><strong>介入:</strong> {{ auto.auto_intervention }}</p>
            {% else %}
              <div class="alert alert-secondary mb-0">自動抽出は処理中／未反映です（後から反映されます）</div>
            {% endif %}
          </div>
        </details>
      </div>
    </div>

    <div class="card mb-3 shadow-sm">
      <div class="card-header bg-light py-2">
        <h5 class="card-title fw-bold mb-0 text-dark"><i class="bi bi-pencil-square me-2"></i>レビュー (あなた)</h5>
      </div>
      <div class="card-body">
      <form method="post" action="/secondary/{{ group }}/{{ pmid }}/save">
        <div class="mb-2">
          <label class="form-label">判定</label>
          <div>
            <label class="form-check-label me-2"><input type="radio" name="decision" value="include" {% if review.decision=='include' %}checked{% endif %}> 採用</label>
            <label class="form-check-label me-2"><input type="radio" name="decision" value="exclude" {% if review.decision=='exclude' %}checked{% endif %}> 除外</label>
            <label class="form-check-label"><input type="radio" name="decision" value="pending" {% if review.decision!='include' and review.decision!='exclude' %}checked{% endif %}> 保留</label>
          </div>
        </div>

        <div class="mb-2">
          <label class="form-label">意欲低下を示す用語（apathy/avolition 等）</label>
          {% if auto and auto.auto_apathy_terms %}
            <div class="form-text text-muted small">自動抽出: {{ auto.auto_apathy_terms }}</div>
          {% endif %}
          <input class="form-control" name="final_apathy_terms" value="{{ review.final_apathy_terms or '' }}">
        </div>

        <div class="mb-2">
          <label class="form-label">対象疾患・病態</label>
          {% if auto and auto.auto_target_condition %}
            <div class="form-text text-muted small">自動抽出: {{ auto.auto_target_condition }}</div>
          {% endif %}
          <input class="form-control" name="final_target_condition" value="{{ review.final_target_condition or '' }}">
        </div>

        <div class="mb-2">
          <label class="form-label">母集団・N</label>
          {% if auto and auto.auto_population_N %}
            <div class="form-text text-muted small">自動抽出: {{ auto.auto_population_N }}</div>
          {% endif %}
          <input class="form-control" name="final_population_n" value="{{ review.final_population_n or '' }}">
        </div>

        <div class="mb-2">
          <label class="form-label">頻度（有症率）</label>
          {% if auto and auto.auto_prevalence %}
            <div class="form-text text-muted small">自動抽出: {{ auto.auto_prevalence }}</div>
          {% endif %}
          <input class="form-control" name="final_prevalence" value="{{ review.final_prevalence or '' }}">
        </div>

        <div class="mb-2">
          <label class="form-label">介入（治療・リハビリ）</label>
          {% if auto and auto.auto_intervention %}
            <div class="form-text text-muted small">自動抽出: {{ auto.auto_intervention }}</div>
          {% endif %}
          <input class="form-control" name="final_intervention" value="{{ review.final_intervention or '' }}">
        </div>

        <div class="d-flex gap-2 pt-2 border-top">
          <button type="submit" name="action" value="save" class="btn btn-primary">保存</button>
          <button type="submit" name="action" value="save_next" class="btn btn-success">保存して次へ</button>
          <button type="submit" name="action" value="exclude_next" class="btn btn-danger">除外して次へ</button>
          <a href="/secondary" class="btn btn-outline-secondary">戻る</a>
        </div>
      </form>
      </div>
    </div>
  </div>
</div>

<style>
/* ===== full width wrapper ===== */
.review-layout-full{
  width: 100%;
  margin-left: calc(-1 * (100vw - 100%)/2);
  margin-right: calc(-1 * (100vw - 100%)/2);
}

/* ===== two-pane layout ===== */
.review-layout{
  display: grid;
  grid-template-columns: 1fr 440px;
  gap: 20px;
  padding: 0 24px;
  max-width: 1200px;
  margin: 0 auto;
}

.review-left{
  min-width: 0;
}

.review-right{
  position: sticky;
  top: 88px; /* navbar + margin */
  /* 固定表示（内部スクロールなし） */
  max-height: none;
  overflow: visible;
  width: 100%;
}

/* Mobile */
@media (max-width: 991px){
  .review-layout{
    grid-template-columns: 1fr;
    padding: 0 12px;
  }
  .review-right{
    position: static;
    max-height: none;
    overflow: visible;
  }
}

/* PDF panel */
.pdf-panel { border:1px solid #ddd; border-radius:8px; overflow:hidden; background:#fff; }
.pdf-panel__toolbar { display:flex; justify-content:flex-end; padding:8px 10px; border-bottom:1px solid #eee; background:#fafafa; }
.pdf-panel__iframe { width:100%; height:70vh; border:0; }
@media (max-width:767px) { .pdf-panel__iframe { height:60vh; } }

/* Gemini */
details.gemini-box > summary{
  cursor:pointer;
  font-weight:600;
}
</style>

{% endblock %}

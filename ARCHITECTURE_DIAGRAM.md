# äºŒæ¬¡ã‚¹ã‚¯ãƒªãƒ¼ãƒ‹ãƒ³ã‚°å†é–²è¦§ãƒ»å†ç·¨é›†æ©Ÿèƒ½ - ã‚¢ãƒ¼ã‚­ãƒ†ã‚¯ãƒãƒ£å›³

## 1. ãƒ‡ãƒ¼ã‚¿ãƒ•ãƒ­ãƒ¼å›³

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    ãƒ¦ãƒ¼ã‚¶ãƒ¼æ“ä½œãƒ•ãƒ­ãƒ¼                             â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

æœªå®Œäº†çŠ¶æ…‹ï¼š
  /secondary (ãƒ€ãƒƒã‚·ãƒ¥ãƒœãƒ¼ãƒ«)
      â”‚
      â”œâ”€ ã€Œå€™è£œä¸€è¦§ã‚’è¡¨ç¤ºã€ã‚¯ãƒªãƒƒã‚¯
      â”‚
      â”œâ”€ æœªå‡¦ç†å€™è£œï¼ˆğŸŸ¡ãƒãƒƒã‚¸ï¼‰è¡¨ç¤º
      â”‚
      â””â”€ ã‚¯ãƒªãƒƒã‚¯ â†’ /secondary/{group}/{pmid}
              â”‚
              â”œâ”€ è©³ç´°ãƒšãƒ¼ã‚¸è¡¨ç¤º
              â”œâ”€ ã€Œå®Œäº†ã¨ã—ã¦ä¿å­˜ã€ãƒœã‚¿ãƒ³è¡¨ç¤º
              â”‚
              â””â”€ ã€Œå®Œäº†ã¨ã—ã¦ä¿å­˜ã€ã‚¯ãƒªãƒƒã‚¯
                      â”‚
                      â”œâ”€ completed_at = ISO8601 timestamp
                      â”œâ”€ DB ä¿å­˜
                      â”‚
                      â””â”€ ãƒšãƒ¼ã‚¸ç•™ã¾ã‚‹ï¼ˆ303 ãƒªãƒ€ã‚¤ãƒ¬ã‚¯ãƒˆï¼‰
                              â”‚
                              â”œâ”€ è­¦å‘Šãƒ¡ãƒƒã‚»ãƒ¼ã‚¸è¡¨ç¤º
                              â”œâ”€ å®Œäº†ãƒãƒƒã‚¸è¡¨ç¤º
                              â””â”€ ã€Œâœ“ å®Œäº†æ¸ˆã¿ã€ãƒœã‚¿ãƒ³è¡¨ç¤º

å®Œäº†æ¸ˆã¿çŠ¶æ…‹ï¼š
  /secondary ã«æˆ»ã‚‹
      â”‚
      â”œâ”€ ã€Œå€™è£œä¸€è¦§ã‚’è¡¨ç¤ºã€ã‚¯ãƒªãƒƒã‚¯
      â”‚
      â”œâ”€ å®Œäº†æ¸ˆã¿å€™è£œï¼ˆâœ“ å®Œäº†æ¸ˆã¿ãƒãƒƒã‚¸ï¼‰è¡¨ç¤º
      â”‚
      â””â”€ ã‚¯ãƒªãƒƒã‚¯ â†’ /secondary/{group}/{pmid}
              â”‚
              â”œâ”€ è©³ç´°ãƒšãƒ¼ã‚¸è¡¨ç¤ºï¼ˆ404 ã‚¨ãƒ©ãƒ¼ãªã—ï¼‰
              â”œâ”€ è­¦å‘Šãƒ¡ãƒƒã‚»ãƒ¼ã‚¸è¡¨ç¤º
              â”œâ”€ å®Œäº†ãƒãƒƒã‚¸è¡¨ç¤º
              â”‚
              â””â”€ å†…å®¹ä¿®æ­£ã—ã¦ã€Œä¿å­˜ã—ã¦æ¬¡ã¸ã€
                      â”‚
                      â”œâ”€ decision/fields æ›´æ–°
                      â”œâ”€ updated_at æ›´æ–°
                      â”œâ”€ completed_at ã¯å¤‰ã‚ã‚‰ãªã„ â† é‡è¦
                      â”‚
                      â””â”€ æ¬¡ã®æœªå‡¦ç†é …ç›®ã¸é€²è¡Œï¼ˆ/nextï¼‰
```

---

## 2. DB ã‚¹ã‚­ãƒ¼ãƒå¤‰æ›´

```
BEFORE (æ—§):
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚    secondaryreview         â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ id (PK)                    â”‚
â”‚ pmid                       â”‚
â”‚ group_name                 â”‚
â”‚ reviewer_id                â”‚
â”‚ decision (pending/...)     â”‚
â”‚ final_citation             â”‚
â”‚ final_apathy_terms         â”‚
â”‚ final_target_condition     â”‚
â”‚ final_population_n         â”‚
â”‚ final_prevalence           â”‚
â”‚ final_intervention         â”‚
â”‚ comment                    â”‚
â”‚ created_at                 â”‚
â”‚ updated_at                 â”‚
â”‚ group                      â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

AFTER (æ–°):
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚    secondaryreview         â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ id (PK)                    â”‚
â”‚ pmid                       â”‚
â”‚ group_name                 â”‚
â”‚ reviewer_id                â”‚
â”‚ decision (pending/...)     â”‚
â”‚ final_citation             â”‚
â”‚ final_apathy_terms         â”‚
â”‚ final_target_condition     â”‚
â”‚ final_population_n         â”‚
â”‚ final_prevalence           â”‚
â”‚ final_intervention         â”‚
â”‚ comment                    â”‚
â”‚ created_at                 â”‚
â”‚ updated_at                 â”‚
â”‚ group                      â”‚
â”‚ completed_at (NEW) â† â˜…     â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

æ–°ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ä»•æ§˜:
  completed_at: Optional[str]
  å€¤: NULLï¼ˆæœªå®Œäº†ï¼‰ã¾ãŸã¯ ISO8601 timestampï¼ˆå®Œäº†æ¸ˆã¿ï¼‰
  ä¾‹: "2025-01-12T10:30:45.123456"
```

---

## 3. ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹é·ç§»å›³

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                   ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹çŠ¶æ…‹é·ç§»                      â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

    â”Œâ”€ NULL
    â”‚  (æœªå®Œäº†)
    â”‚
    â”œâ”€ decision = pending
    â”‚  completed_at = NULL
    â”‚  è¡¨ç¤º: ğŸŸ¡ æœªå‡¦ç†
    â”‚  æ“ä½œ: ã€Œå®Œäº†ã¨ã—ã¦ä¿å­˜ã€å¯èƒ½
    â”‚  /next: å¯¾è±¡ï¼ˆpending ã ã‹ã‚‰ï¼‰
    â”‚
    â”œâ”€ [ã€Œå®Œäº†ã¨ã—ã¦ä¿å­˜ã€ã‚¯ãƒªãƒƒã‚¯]
    â”‚
    â”œâ”€ decision = pending (å¤‰ã‚ã‚‰ãš)
    â”‚  completed_at = "2025-01-12T10:30:45"
    â”‚  è¡¨ç¤º: âœ“ å®Œäº†æ¸ˆã¿ï¼ˆæ–°ã—ã„ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ï¼‰
    â”‚  æ“ä½œ: å†ç·¨é›†å¯èƒ½
    â”‚  /next: å¯¾è±¡ï¼ˆdecision = pending ã ã‹ã‚‰ï¼‰ â† é‡è¦
    â”‚
    â”œâ”€ [ã€Œä¿å­˜ã—ã¦æ¬¡ã¸ã€ã§ decision å¤‰æ›´]
    â”‚
    â”œâ”€ decision = include (å¤‰æ›´)
    â”‚  completed_at = "2025-01-12T10:30:45" (å¤‰ã‚ã‚‰ãš)
    â”‚  è¡¨ç¤º: âœ“ æ¡ç”¨
    â”‚  æ“ä½œ: å†ç·¨é›†ä¸å¯ï¼ˆdecision != pendingï¼‰
    â”‚  /next: éå¯¾è±¡ï¼ˆdecision != pendingï¼‰
    â”‚
    â””â”€ çµ‚äº†
```

---

## 4. ã‚¨ãƒ³ãƒ‰ãƒã‚¤ãƒ³ãƒˆ ãƒ­ã‚¸ãƒƒã‚¯å›³

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ GET /secondary (ãƒ€ãƒƒã‚·ãƒ¥ãƒœãƒ¼ãƒ«)                           â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

å…¥åŠ›: user (ãƒ¦ãƒ¼ã‚¶ãƒ¼æƒ…å ±)

å‡¦ç†:
  1. å„ã‚°ãƒ«ãƒ¼ãƒ— (physical, brain, psycho, drug) ã«å¯¾ã—ã¦:
     â”œâ”€ ç·æ•°: COUNT(*) WHERE group = g
     â”œâ”€ æœªå‡¦ç†: COUNT(*) WHERE decision = 'pending'
     â”œâ”€ æ¡ç”¨: COUNT(*) WHERE decision = 'include'
     â”œâ”€ é™¤å¤–: COUNT(*) WHERE decision = 'exclude'
     â””â”€ å®Œäº†æ¸ˆã¿: COUNT(*) WHERE completed_at IS NOT NULL â† NEW
  
  2. candidates_by_group dict ç”Ÿæˆ:
     â”œâ”€ PMID ãƒªã‚¹ãƒˆ
     â”œâ”€ å„å€™è£œã®:
     â”‚  â”œâ”€ decision
     â”‚  â”œâ”€ completed_at
     â”‚  â””â”€ is_completed (ãƒ–ãƒ¼ãƒ«å€¤)
     â””â”€ ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆã«æ¸¡ã™

å‡ºåŠ›: dashboard.html (candidates_by_group ã‚’ render)


â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ GET /secondary/{group}/{pmid} (è©³ç´°ãƒšãƒ¼ã‚¸)                â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

å…¥åŠ›: group, pmid, user

å‡¦ç†:
  1. SecondaryReview å–å¾—:
     SELECT * WHERE pmid=? AND group=? AND reviewer_id=?
     â””â”€ â˜… completed_at ã§ã¯é™¤å¤–ã—ãªã„ â† é‡è¦

  2. å–å¾—çµæœ:
     â”œâ”€ è¦‹ã¤ã‹ã£ãŸ â†’ è©³ç´°ãƒšãƒ¼ã‚¸è¡¨ç¤º
     â”‚  â”œâ”€ review.completed_at = NULL â†’ é€šå¸¸è¡¨ç¤º
     â”‚  â””â”€ review.completed_at != NULL â†’ è­¦å‘Šãƒ¡ãƒƒã‚»ãƒ¼ã‚¸è¡¨ç¤º
     â””â”€ è¦‹ã¤ã‹ã‚‰ãªã„ â†’ 404 ã‚¨ãƒ©ãƒ¼

å‡ºåŠ›: secondary_review.html (review ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆ)


â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ POST /secondary/{group}/{pmid}/save (ä¿å­˜)                â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

å…¥åŠ›: group, pmid, user, form_data (action, decision, ...)

å‡¦ç†:
  1. æ¨©é™ç¢ºèª
  
  2. Review å–å¾— (ä¸Šè¨˜ã¨åŒã˜)
  
  3. action ç¢ºèª:
     â”œâ”€ action == 'complete':
     â”‚  â””â”€ completed_at = datetime.utcnow().isoformat()
     â”œâ”€ action == 'exclude_next':
     â”‚  â””â”€ decision = 'exclude'
     â””â”€ else:
        â””â”€ decision = form_data['decision']
  
  4. ä»–ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰æ›´æ–°:
     â”œâ”€ final_citation
     â”œâ”€ final_apathy_terms
     â”œâ”€ final_target_condition
     â”œâ”€ final_population_n
     â”œâ”€ final_prevalence
     â”œâ”€ final_intervention
     â”œâ”€ comment
     â””â”€ updated_at = datetime.utcnow().isoformat()
  
  5. DB ä¿å­˜:
     session.add(review)
     session.commit()
  
  6. ãƒŠãƒ“ã‚²ãƒ¼ã‚·ãƒ§ãƒ³:
     â”œâ”€ action == 'complete': åŒãƒšãƒ¼ã‚¸ã«ãƒªãƒ€ã‚¤ãƒ¬ã‚¯ãƒˆ
     â”œâ”€ action == 'exclude_next': /next ã¸
     â””â”€ nav == 'next': /next ã¸

å‡ºåŠ›: RedirectResponse (303)


â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ GET /secondary/{group}/next (æ¬¡ã®æœªå‡¦ç†)                  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

å…¥åŠ›: group, user

å‡¦ç†:
  1. æœªå‡¦ç†ã®å€™è£œã‚’å–å¾—:
     SELECT * WHERE 
       group=? AND reviewer_id=? AND decision='pending'
     â””â”€ â˜… completed_at ã¯ç„¡è¦– â† é‡è¦
     â””â”€ decision='pending' ãªã‚‰è¡¨ç¤ºï¼ˆå®Œäº†æ¸ˆã¿ã§ã‚‚OKï¼‰

  2. å–å¾—çµæœ:
     â”œâ”€ ã‚ã£ãŸ â†’ æœ€åˆã®å€™è£œã¸ãƒªãƒ€ã‚¤ãƒ¬ã‚¯ãƒˆ
     â””â”€ ãªã‹ã£ãŸ â†’ /secondary ã¸

å‡ºåŠ›: RedirectResponse â†’ /secondary/{group}/{pmid}
```

---

## 5. Template ãƒ­ã‚¸ãƒƒã‚¯å›³

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ templates/secondary_index.html                           â”‚
â”‚ (ãƒ€ãƒƒã‚·ãƒ¥ãƒœãƒ¼ãƒ«)                                          â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

ãƒ‡ãƒ¼ã‚¿å…¥åŠ›:
  - stats (total, pending, included, excluded, completed)
  - candidates_by_group[g] (pmid, decision, is_completed)

Template ãƒ­ã‚¸ãƒƒã‚¯:

  {% for g in ['physical', 'brain', 'psycho', 'drug'] %}
    <div class="card">
      <h5>{{ g }}</h5>
      
      <!-- çµ±è¨ˆè¡¨ç¤º -->
      <p>
        åˆè¨ˆ: {{ stats[g].total }}
        æœªå‡¦ç†: {{ stats[g].pending }}
        æ¡ç”¨: {{ stats[g].included }}
        é™¤å¤–: {{ stats[g].excluded }}
        {% if stats[g].completed > 0 %}
          å®Œäº†æ¸ˆã¿: <span class="badge badge-completed">
            {{ stats[g].completed }}
          </span>
        {% endif %}
      </p>
      
      <!-- ã€Œæ¬¡ã¸ã€ãƒœã‚¿ãƒ³ -->
      <a href="/secondary/{{ g }}/next">æ¬¡ã®æœªç€æ‰‹ã¸</a>
      
      <!-- å±•é–‹å¼ãƒªã‚¹ãƒˆ -->
      <button data-toggle="collapse" data-target="#candidates-{{ g }}">
        å€™è£œä¸€è¦§ã‚’è¡¨ç¤º
      </button>
      
      <div class="collapse" id="candidates-{{ g }}">
        {% for cand in candidates_by_group[g] %}
          <div class="candidate-item">
            <a href="/secondary/{{ g }}/{{ cand.pmid }}">
              PMID: {{ cand.pmid }}
            </a>
            
            <!-- ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ãƒãƒƒã‚¸ -->
            <span class="badge"
              {% if cand.is_completed %}
                style="background-color: #17a2b8;"
              {% elif cand.status == 'pending' %}
                style="background-color: #ffc107;"
              {% elif cand.status == 'include' %}
                style="background-color: #28a745;"
              {% elif cand.status == 'exclude' %}
                style="background-color: #dc3545;"
              {% endif %}
            >
              {% if cand.is_completed %}
                âœ“ å®Œäº†æ¸ˆã¿
              {% elif cand.status == 'pending' %}
                ğŸŸ¡ æœªå‡¦ç†
              {% elif cand.status == 'include' %}
                âœ“ æ¡ç”¨
              {% elif cand.status == 'exclude' %}
                âœ— é™¤å¤–
              {% endif %}
            </span>
          </div>
        {% endfor %}
      </div>
    </div>
  {% endfor %}


â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ templates/secondary_review.html                          â”‚
â”‚ (è©³ç´°ãƒšãƒ¼ã‚¸)                                              â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

ãƒ‡ãƒ¼ã‚¿å…¥åŠ›:
  - review (completed_at, decision, ...)
  - auto (auto-extraction results)

Template ãƒ­ã‚¸ãƒƒã‚¯:

  <!-- ãƒ˜ãƒƒãƒ€ãƒ¼ -->
  <h5>ãƒ¬ãƒ“ãƒ¥ãƒ¼ (ã‚ãªãŸ)
    {% if review.completed_at %}
      <span class="badge bg-info">å®Œäº†æ¸ˆã¿</span>
    {% endif %}
  </h5>
  
  <!-- è­¦å‘Šãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ -->
  {% if review.completed_at %}
    <div class="alert alert-info">
      â„¹ï¸ ã“ã®ãƒ¬ãƒ“ãƒ¥ãƒ¼ã¯ {{ review.completed_at }} ã«å®Œäº†ã•ã‚Œã¦ã„ã¾ã™ã€‚
      ä¿®æ­£å†…å®¹ã‚’ä¿å­˜ã™ã‚‹å ´åˆã¯ã€Œä¿å­˜ã€ãƒœã‚¿ãƒ³ã§å†ä¿å­˜ã—ã¦ãã ã•ã„ã€‚
    </div>
  {% endif %}
  
  <!-- ãƒ•ã‚©ãƒ¼ãƒ  -->
  <form method="post" action="/secondary/{{ group }}/{{ pmid }}/save">
    
    <!-- åˆ¤å®šãƒœã‚¿ãƒ³ -->
    <div class="d-flex gap-2">
      <button type="button" class="decision-btn" data-value="include">
        æ¡ç”¨
      </button>
      <button type="button" class="decision-btn" data-value="exclude">
        é™¤å¤–
      </button>
    </div>
    
    <!-- ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ -->
    <textarea name="final_apathy_terms">...</textarea>
    <textarea name="final_target_condition">...</textarea>
    ...
    
    <!-- ãƒœã‚¿ãƒ³ -->
    <div class="d-flex gap-2">
      <button type="submit" name="nav" value="prev">
        â† 1ã¤å‰ã«æˆ»ã‚‹
      </button>
      
      {% if not review.completed_at %}
        <!-- æœªå®Œäº†: å®Œäº†ãƒœã‚¿ãƒ³ -->
        <button type="submit" name="action" value="complete" 
          class="btn btn-warning">
          âœ“ å®Œäº†ã¨ã—ã¦ä¿å­˜
        </button>
      {% else %}
        <!-- å®Œäº†æ¸ˆã¿: ãƒãƒƒã‚¸ã®ã¿ -->
        <span class="badge bg-info">âœ“ å®Œäº†æ¸ˆã¿</span>
      {% endif %}
      
      <button type="submit" name="nav" value="next" class="btn btn-primary">
        ä¿å­˜ã—ã¦æ¬¡ã¸ â†’
      </button>
    </div>
  </form>
```

---

## 6. ã‚¯ãƒ©ã‚¹æ§‹é€ 

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ app/models.py                                           â”‚
â”‚ class SecondaryReview                                   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

SecondaryReview:
  â”œâ”€ id: int (Primary Key)
  â”œâ”€ pmid: int
  â”œâ”€ group_name: str
  â”œâ”€ reviewer_id: int
  â”œâ”€ decision: str (pending | include | exclude)
  â”œâ”€ final_citation: str
  â”œâ”€ final_apathy_terms: str
  â”œâ”€ final_target_condition: str
  â”œâ”€ final_population_n: str
  â”œâ”€ final_prevalence: str
  â”œâ”€ final_intervention: str
  â”œâ”€ comment: str
  â”œâ”€ created_at: str (ISO 8601)
  â”œâ”€ updated_at: str (ISO 8601)
  â”œâ”€ group: str
  â””â”€ completed_at: Optional[str] (ISO 8601 or NULL) â† NEW

æ–°ã—ã„ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ã®å½¹å‰²:
  - NULL: æœªå®Œäº†ï¼ˆãƒ‡ãƒ•ã‚©ãƒ«ãƒˆï¼‰
  - timestamp: å®Œäº†æ™‚åˆ»
  - decision ã‹ã‚‰å®Œå…¨ã«ç‹¬ç«‹
  - å®Œäº†/æœªå®Œäº†ã®ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ã‚’è¡¨ã™
```

---

## 7. API ä»•æ§˜

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ æ—¢å­˜ APIï¼ˆå¤‰æ›´ãªã—ï¼‰                                     â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

GET /secondary
  â””â”€ Response: { stats: {...}, candidates_by_group: {...} }

GET /secondary/{group}/{pmid}
  â””â”€ Response: { review: SecondaryReview, auto: ... }

GET /secondary/{group}/next
  â””â”€ Response: RedirectResponse â†’ /secondary/{group}/{pmid}

POST /secondary/{group}/{pmid}/save
  â”œâ”€ Params: group, pmid
  â”œâ”€ Form: decision, final_*, comment, nav, action, ...
  â””â”€ Response: RedirectResponse


â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ æ–°è¦ Form ãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿                                     â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

POST /secondary/{group}/{pmid}/save
  â”œâ”€ action = 'complete' â† NEW
  â”‚  â””â”€ åŠ¹æœ: completed_at = ISO 8601 timestamp
  â”‚  â””â”€ ãƒªãƒ€ã‚¤ãƒ¬ã‚¯ãƒˆ: åŒãƒšãƒ¼ã‚¸ (303)
  â”‚
  â”œâ”€ action = 'exclude_next' (æ—¢å­˜)
  â”‚  â””â”€ åŠ¹æœ: decision = 'exclude'
  â”‚  â””â”€ ãƒªãƒ€ã‚¤ãƒ¬ã‚¯ãƒˆ: /next
  â”‚
  â””â”€ nav = 'next' (æ—¢å­˜)
     â””â”€ åŠ¹æœ: decision ä¿å­˜
     â””â”€ ãƒªãƒ€ã‚¤ãƒ¬ã‚¯ãƒˆ: /next
```

---

## 8. ãƒ†ã‚¹ãƒˆ ãƒãƒˆãƒªãƒƒã‚¯ã‚¹

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ ãƒ†ã‚¹ãƒˆã‚±ãƒ¼ã‚¹ ãƒãƒˆãƒªãƒƒã‚¯ã‚¹                                 â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

Case 1: æœªå®Œäº† â†’ å®Œäº†
  çŠ¶æ…‹: decision=pending, completed_at=NULL
  æ“ä½œ: ã€Œå®Œäº†ã¨ã—ã¦ä¿å­˜ã€ ã‚¯ãƒªãƒƒã‚¯
  çµæœ: âœ“
    â”œâ”€ completed_at = ISO 8601 timestamp
    â”œâ”€ decision = pending (å¤‰ã‚ã‚‰ãš)
    â”œâ”€ ãƒšãƒ¼ã‚¸ç•™ã¾ã‚‹
    â””â”€ è­¦å‘Šãƒ¡ãƒƒã‚»ãƒ¼ã‚¸è¡¨ç¤º

Case 2: å®Œäº†æ¸ˆã¿ â†’ å†ç·¨é›† â†’ decision å¤‰æ›´
  çŠ¶æ…‹: decision=pending, completed_at="2025-01-12T..."
  æ“ä½œ: decision=include é¸æŠ â†’ ã€Œä¿å­˜ã—ã¦æ¬¡ã¸ã€
  çµæœ: âœ“
    â”œâ”€ decision = include (å¤‰æ›´)
    â”œâ”€ completed_at = "2025-01-12T..." (å¤‰ã‚ã‚‰ãš)
    â”œâ”€ /next ã¸é·ç§»
    â””â”€ /next ã¯ decision=pending ã®æ¬¡é …ç›®ã¸

Case 3: å®Œäº†æ¸ˆã¿ â†’ /next ã§è¡¨ç¤ºã•ã‚Œã‚‹ã‹
  çŠ¶æ…‹: decision=pending, completed_at="2025-01-12T..."
  æ“ä½œ: /next ã‚¨ãƒ³ãƒ‰ãƒã‚¤ãƒ³ãƒˆå‘¼ã³å‡ºã—
  çµæœ: âœ“
    â”œâ”€ ã“ã®é …ç›®ãŒå€™è£œã«å«ã¾ã‚Œã‚‹
    â””â”€ (decision=pending ã ã‹ã‚‰)

Case 4: å®Œäº†æ¸ˆã¿ â†’ URL ç›´æ‰“ã¡ã‚¢ã‚¯ã‚»ã‚¹
  çŠ¶æ…‹: decision=pending, completed_at="2025-01-12T..."
  æ“ä½œ: /secondary/{group}/{pmid} ç›´æ‰“ã¡
  çµæœ: âœ“
    â”œâ”€ 404 ã‚¨ãƒ©ãƒ¼ãªã—
    â”œâ”€ è©³ç´°ãƒšãƒ¼ã‚¸è¡¨ç¤º
    â””â”€ è­¦å‘Šãƒ¡ãƒƒã‚»ãƒ¼ã‚¸è¡¨ç¤º

Case 5: ãƒ€ãƒƒã‚·ãƒ¥ãƒœãƒ¼ãƒ«è¡¨ç¤º
  æ“ä½œ: /secondary ã«ã‚¢ã‚¯ã‚»ã‚¹
  çµæœ: âœ“
    â”œâ”€ å®Œäº†æ¸ˆã¿çµ±è¨ˆè¡¨ç¤º
    â”œâ”€ å®Œäº†æ¸ˆã¿é …ç›®ã« âœ“ ãƒãƒƒã‚¸è¡¨ç¤º
    â””â”€ ã‚¯ãƒªãƒƒã‚¯å¯èƒ½
```

---

## 9. Migration ãƒ•ãƒ­ãƒ¼

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Migration å®Ÿè¡Œãƒ•ãƒ­ãƒ¼                                     â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

1. Migration ã‚¹ã‚¯ãƒªãƒ—ãƒˆå®Ÿè¡Œ
   python -m app.scripts.migrate_add_completed_at_secondary
   
   â”œâ”€ DB æ¥ç¶š (DATABASE_URL ã‹ã‚‰)
   â”œâ”€ ãƒ†ãƒ¼ãƒ–ãƒ«ã‚¹ã‚­ãƒ¼ãƒå–å¾—
   â”œâ”€ completed_at å­˜åœ¨ç¢ºèª
   â”‚  â”œâ”€ å­˜åœ¨ â†’ ã‚¹ã‚­ãƒƒãƒ— (å†ªç­‰æ€§)
   â”‚  â””â”€ éå­˜åœ¨ â†’ ALTER TABLE å®Ÿè¡Œ
   â””â”€ å®Ÿè¡Œçµæœ:
      â”œâ”€ Column added successfully
      â””â”€ Verification passed

2. æ—¢å­˜ãƒ‡ãƒ¼ã‚¿ã¸ã®å½±éŸ¿:
   â”œâ”€ å…¨è¡Œ: completed_at = NULL (ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆ)
   â””â”€ æ—¢å­˜ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰: å¤‰æ›´ãªã—

3. Rollback å¯èƒ½:
   DROP COLUMN completed_at
```

---

## 10. ãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹è€ƒæ…®

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ ãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹æœ€é©åŒ–                                      â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

Query 1: å®Œäº†æ¸ˆã¿çµ±è¨ˆè¨ˆç®—
  SELECT COUNT(*) WHERE completed_at IS NOT NULL
  â”œâ”€ Index: ãªã— (TEXT å‹ã€count query ã®ãŸã‚å•é¡Œãªã—)
  â””â”€ ãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹: OK (ãƒ†ãƒ¼ãƒ–ãƒ« å°)

Query 2: /next ãƒ•ã‚£ãƒ«ã‚¿ãƒªãƒ³ã‚°
  SELECT * WHERE decision='pending'
  â”œâ”€ completed_at ã¯ç„¡è¦–
  â”œâ”€ Index: (group, reviewer_id, decision) æ—¢å­˜
  â””â”€ ãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹: OK

Query 3: è©³ç´°ãƒšãƒ¼ã‚¸å–å¾—
  SELECT * WHERE pmid=? AND group=? AND reviewer_id=?
  â”œâ”€ completed_at ã¯ç„¡è¦–
  â”œâ”€ Index: (pmid, group, reviewer_id) æ—¢å­˜
  â””â”€ ãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹: OK

è¿½åŠ ã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹: ä¸è¦
  â””â”€ completed_at ã¯ WHERE ã§ä½¿ç”¨ã•ã‚Œãšã€å˜ãªã‚‹ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹
```

---

**Last Updated**: 2025-01-12  
**Version**: 1.0  
**Status**: Complete
